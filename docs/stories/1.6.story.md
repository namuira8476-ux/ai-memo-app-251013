# Story 1.6: 세션 상태 관리

## Status
Draft

## Story
**As a** 로그인된 사용자,
**I want** 세션이 자동으로 갱신되고 만료 시 적절히 처리되도록,
**so that** 사용 중에 갑작스럽게 로그아웃되지 않고, 만료 시에는 다시 로그인할 수 있다

## Acceptance Criteria
1. 사용자 세션이 자동으로 갱신된다 (세션 만료 전)
2. 세션이 만료되면 자동으로 로그아웃 처리된다
3. 세션 만료 시 사용자에게 알림을 표시한다 (토스트 메시지)
4. 세션 만료 후 로그인 페이지로 리다이렉트된다
5. 로그인 페이지에서 "세션이 만료되었습니다" 메시지를 표시한다
6. 새로고침 시에도 세션 상태가 유지된다
7. 여러 탭에서 동시에 사용 시 세션 상태가 동기화된다
8. 네트워크 오류 시 세션 갱신을 재시도한다 (최대 3회)
9. 세션 갱신 실패 시 로그를 남긴다
10. 로그인 상태에서 브라우저를 닫고 재접속 시 세션이 유지된다

## Tasks / Subtasks
- [ ] Task 1: 세션 자동 갱신 구현 (AC: 1, 6, 10)
  - [ ] Supabase Auth onAuthStateChange 리스너 설정
  - [ ] 세션 자동 갱신 로직 구현
  - [ ] 세션 토큰 리프레시 처리
  - [ ] 브라우저 새로고침 시 세션 복원
- [ ] Task 2: 세션 만료 처리 구현 (AC: 2, 3, 4, 5)
  - [ ] 세션 만료 감지 로직
  - [ ] 자동 로그아웃 처리
  - [ ] 토스트 알림 표시 (세션 만료 메시지)
  - [ ] 로그인 페이지 리다이렉트
  - [ ] 로그인 페이지에 만료 메시지 전달
- [ ] Task 3: 멀티 탭 세션 동기화 (AC: 7)
  - [ ] localStorage 또는 BroadcastChannel 사용
  - [ ] 탭 간 세션 상태 동기화
  - [ ] 한 탭에서 로그아웃 시 모든 탭에서 로그아웃
- [ ] Task 4: 네트워크 오류 처리 (AC: 8, 9)
  - [ ] 세션 갱신 재시도 로직 (최대 3회)
  - [ ] 재시도 간격 설정 (exponential backoff)
  - [ ] 세션 갱신 실패 시 에러 로그
  - [ ] 네트워크 복구 시 자동 재갱신
- [ ] Task 5: 세션 관리 유틸리티 구현
  - [ ] SessionManager 클래스 또는 훅 생성
  - [ ] 세션 상태 확인 함수
  - [ ] 세션 갱신 함수
  - [ ] 세션 만료 처리 함수
- [ ] Task 6: 테스트 작성
  - [ ] 세션 자동 갱신 테스트
  - [ ] 세션 만료 처리 테스트
  - [ ] 멀티 탭 동기화 테스트
  - [ ] 네트워크 오류 재시도 테스트
  - [ ] 세션 복원 테스트

## Dev Notes

### Previous Story Insights
Story 1.1~1.4에서 이미 구현된 내용:
- Supabase Auth 완전 구현 (회원가입, 로그인, 비밀번호 재설정, 로그아웃)
- 클라이언트 및 서버 Supabase 클라이언트 설정
- 기본적인 인증 상태 관리
- 로그인/로그아웃 플로우

현재 부족한 부분:
- 세션 자동 갱신 로직 없음
- 세션 만료 시 처리 로직 없음
- 멀티 탭 세션 동기화 없음
- 네트워크 오류 처리 없음

### Data Models
- **Session State**:
  - Supabase Auth가 자동으로 관리
  - access_token, refresh_token 자동 갱신
- **Session Metadata**:
  - expires_at: 세션 만료 시간
  - user: 현재 사용자 정보
  - 상태: authenticated, unauthenticated

### API Specifications
- **Supabase Auth API**:
  - `onAuthStateChange()`: 인증 상태 변경 리스너
  - `getSession()`: 현재 세션 조회
  - `refreshSession()`: 세션 수동 갱신
  - `setSession()`: 세션 설정
  - `signOut()`: 로그아웃
- **Session Events**:
  - INITIAL_SESSION: 초기 세션 로드
  - SIGNED_IN: 로그인 완료
  - SIGNED_OUT: 로그아웃 완료
  - TOKEN_REFRESHED: 토큰 갱신 완료
  - USER_UPDATED: 사용자 정보 업데이트

### Component Specifications
- **SessionProvider** (Context Provider):
  - Client Component
  - Props: children
  - Context: session, isLoading, refreshSession
  - 전역 세션 상태 관리
- **useSession Hook**:
  - 세션 상태 및 메서드 제공
  - 사용법: `const { session, isLoading } = useSession()`
- **Toast Component** (shadcn/ui):
  - 세션 만료 알림 표시
  - Props: message, type (info, warning, error)

### File Locations
- `/lib/supabase/session-manager.ts`: 세션 관리 유틸리티
- `/lib/hooks/use-session.ts`: 세션 관리 훅
- `/contexts/session-context.tsx`: 세션 컨텍스트 (필요 시)
- `/app/layout.tsx`: SessionProvider 추가
- `/components/ui/toast.tsx`: 토스트 컴포넌트 (shadcn/ui)
- `/lib/supabase/client.ts`: 클라이언트 Supabase 설정 (수정)
- `/__tests__/session/`: 세션 관리 테스트 파일

### Testing Requirements
- **Unit Tests**: `/__tests__/session/` 디렉토리에 테스트 파일 생성
- **Testing Framework**: Jest + React Testing Library
- **Test Coverage**: 
  - 세션 자동 갱신
  - 세션 만료 처리
  - 멀티 탭 동기화
  - 네트워크 오류 재시도
  - 세션 복원
- **Integration Tests**: 전체 세션 관리 플로우 테스트
- **E2E Tests** (선택적): 실제 세션 만료 시나리오 테스트

### Technical Constraints
- **Next.js App Router**: `/app` 디렉토리 구조 사용
- **Supabase Auth**: 세션 관리 자동화
- **React Context API**: 전역 세션 상태 관리 (또는 Zustand/Jotai)
- **localStorage**: 세션 지속성 (Supabase가 자동 관리)
- **BroadcastChannel**: 멀티 탭 동기화
- **Tailwind CSS**: 스타일링 전용
- **shadcn/ui**: 토스트 컴포넌트
- **TypeScript**: 타입 안전성 보장

### Session Management Strategy
- **자동 갱신**: Supabase Auth가 자동으로 토큰 갱신
- **만료 감지**: onAuthStateChange 리스너로 SIGNED_OUT 이벤트 감지
- **멀티 탭**: BroadcastChannel 또는 localStorage 이벤트 사용
- **재시도**: exponential backoff 전략 (1초, 2초, 4초)
- **로깅**: console.error 또는 Sentry (선택적)

### Security Considerations
- **토큰 저장**: Supabase가 자동으로 안전하게 저장 (httpOnly 쿠키)
- **토큰 갱신**: HTTPS 통신만 허용
- **세션 만료**: 자동 로그아웃 및 재로그인 필요
- **XSS 방지**: 토큰을 JavaScript로 직접 다루지 않음

### Performance Considerations
- **리스너 효율성**: 불필요한 리렌더링 방지 (useMemo, useCallback)
- **네트워크 재시도**: exponential backoff로 서버 부하 최소화
- **멀티 탭 동기화**: 이벤트 디바운싱

## Testing
### Testing Standards
- **Test File Location**: `/__tests__/session/` 디렉토리
- **Test Framework**: Jest + React Testing Library
- **Test Patterns**: 
  - Unit tests for session manager
  - Integration tests for session lifecycle
  - Multi-tab synchronization tests
  - Network error retry tests
  - Session restoration tests
- **Coverage Requirements**: 핵심 기능 80% 이상 커버리지
- **Mock Strategy**: 
  - Supabase Auth API 모킹
  - localStorage/BroadcastChannel 모킹
  - Timer 모킹 (재시도 로직)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | 초기 스토리 생성 | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
*개발 에이전트가 작성*

### Debug Log References
*개발 에이전트가 작성*

### Completion Notes List
*개발 에이전트가 작성*

### File List
*개발 에이전트가 작성*

## QA Results
*QA 에이전트가 검토 후 작성*



