# Story 1.3: 비밀번호 재설정

## Status
Ready for Review

## Story
**As a** 사용자,
**I want** 비밀번호를 재설정할 수 있도록,
**so that** 비밀번호를 잊어버렸을 때도 계정에 다시 접근할 수 있다

## Acceptance Criteria
1. 사용자가 이메일 주소를 입력할 수 있는 비밀번호 재설정 요청 폼을 제공한다
2. 이메일 형식 유효성 검사를 실시한다
3. 존재하지 않는 이메일에 대해 적절한 에러 메시지를 표시한다
4. 비밀번호 재설정 이메일 발송 성공 시 확인 메시지를 표시한다
5. 비밀번호 재설정 이메일 발송 실패 시 적절한 에러 메시지를 표시한다
6. 비밀번호 재설정 요청 중 로딩 상태를 표시한다
7. 비밀번호 재설정 이메일의 링크를 통해 새 비밀번호 설정 페이지로 이동할 수 있다
8. 새 비밀번호 설정 시 비밀번호는 최소 8자 이상이며 특수문자를 포함해야 한다
9. 새 비밀번호 설정 성공 시 로그인 페이지로 리다이렉트한다
10. 새 비밀번호 설정 실패 시 적절한 에러 메시지를 표시한다

## Tasks / Subtasks
- [x] Task 1: 비밀번호 재설정 요청 UI 구현 (AC: 1, 2, 6)
  - [x] 비밀번호 재설정 요청 페이지 생성 (/auth/reset-password)
  - [x] 이메일 입력 폼 구현
  - [x] 이메일 형식 유효성 검사
  - [x] 로딩 상태 표시
- [x] Task 2: 비밀번호 재설정 요청 로직 구현 (AC: 3, 4, 5)
  - [x] Supabase Auth resetPasswordForEmail 함수 호출
  - [x] 존재하지 않는 이메일 에러 핸들링
  - [x] 이메일 발송 성공/실패 메시지 표시
- [x] Task 3: 새 비밀번호 설정 UI 구현 (AC: 7, 8)
  - [x] 새 비밀번호 설정 페이지 생성 (/auth/update-password)
  - [x] 새 비밀번호 입력 폼 구현
  - [x] 비밀번호 유효성 검사 (8자 이상, 특수문자 포함)
  - [x] 비밀번호 확인 입력 필드
- [x] Task 4: 새 비밀번호 설정 로직 구현 (AC: 9, 10)
  - [x] Supabase Auth updateUser 함수 호출
  - [x] 비밀번호 업데이트 성공/실패 처리
  - [x] 성공 시 로그인 페이지 리다이렉트
- [x] Task 5: 라우팅 및 네비게이션 설정
  - [x] 비밀번호 재설정 링크를 로그인 페이지에 추가
  - [x] 이메일 링크에서 토큰 검증 및 페이지 접근 제어
- [x] Task 6: 테스트 작성
  - [x] 비밀번호 재설정 요청 테스트
  - [x] 새 비밀번호 설정 테스트
  - [x] 에러 케이스 테스트
  - [x] 이메일 링크 처리 테스트

## Dev Notes

### Previous Story Insights
Story 1.1, 1.2에서 이미 구현된 내용:
- Supabase Auth 클라이언트 설정 완료 (클라이언트 및 서버)
- shadcn/ui 컴포넌트 (Button, Input, Label) 사용 가능
- 이메일 형식 유효성 검사 로직 구현됨
- 비밀번호 유효성 검사 로직 구현됨 (8자 이상, 특수문자 포함)
- 에러 핸들링 및 로딩 상태 표시 패턴 구현됨

### Data Models
- **User Authentication**: Supabase Auth를 통한 사용자 관리
- **Password Reset Token**: Supabase Auth에서 자동 생성되는 재설정 토큰
- **Email Verification**: 이메일 기반 비밀번호 재설정 플로우

### API Specifications
- **Supabase Auth API**:
  - `resetPasswordForEmail(email)`: 비밀번호 재설정 이메일 발송
  - `updateUser({ password })`: 새 비밀번호 설정
  - `getUser()`: 현재 사용자 정보 조회
  - `onAuthStateChange()`: 인증 상태 변경 감지

### Component Specifications
- **PasswordResetRequestForm Component**:
  - Props: 없음
  - State: email, loading, error, success
  - Validation: 이메일 형식 검증
  - Error Handling: 존재하지 않는 이메일, 발송 실패 처리
- **PasswordUpdateForm Component**:
  - Props: 없음
  - State: password, confirmPassword, loading, error
  - Validation: 비밀번호 길이 및 특수문자 포함 검증
  - Error Handling: 비밀번호 업데이트 실패 처리

### File Locations
- `/app/auth/reset-password/page.tsx`: 비밀번호 재설정 요청 페이지
- `/app/auth/update-password/page.tsx`: 새 비밀번호 설정 페이지
- `/components/auth/password-reset-request-form.tsx`: 비밀번호 재설정 요청 폼
- `/components/auth/password-update-form.tsx`: 새 비밀번호 설정 폼
- `/lib/supabase/client.ts`: Supabase 클라이언트 설정 (이미 존재)
- `/lib/supabase/server.ts`: 서버 사이드 Supabase 설정 (이미 존재)

### Testing Requirements
- **Unit Tests**: `/__tests__/` 디렉토리에 테스트 파일 생성
- **Testing Framework**: Jest + React Testing Library
- **Test Coverage**: 폼 유효성 검사, API 호출, 에러 핸들링, 이메일 링크 처리
- **Integration Tests**: Supabase Auth 비밀번호 재설정 플로우 테스트

### Technical Constraints
- **Next.js App Router**: `/app` 디렉토리 구조 사용
- **Server Actions**: 서버 사이드 로직 구현
- **Tailwind CSS**: 스타일링 전용
- **shadcn/ui**: UI 컴포넌트 라이브러리
- **TypeScript**: 타입 안전성 보장

### Security Considerations
- **Email Verification**: 이메일 기반 비밀번호 재설정으로 보안 강화
- **Token Expiration**: Supabase Auth에서 자동 관리되는 토큰 만료
- **Password Validation**: 기존과 동일한 비밀번호 정책 적용
- **Rate Limiting**: Supabase Auth에서 제공하는 요청 제한

## Testing
### Testing Standards
- **Test File Location**: `/__tests__/` 디렉토리
- **Test Framework**: Jest + React Testing Library
- **Test Patterns**: 
  - Unit tests for form validation (이메일 형식, 비밀번호 정책)
  - Integration tests for Supabase Auth 비밀번호 재설정
  - Error handling tests (존재하지 않는 이메일, 업데이트 실패)
  - Email link processing tests
- **Coverage Requirements**: 핵심 기능 80% 이상 커버리지

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-01-XX | 1.0 | 초기 스토리 생성 | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
없음 - 모든 구현이 첫 시도에 성공

### Completion Notes List
- 비밀번호 재설정 요청 폼 및 페이지 구현 완료
- 새 비밀번호 설정 폼 및 페이지 구현 완료
- Supabase Auth resetPasswordForEmail 및 updateUser 함수 연동 완료
- 이메일 형식 유효성 검사 및 비밀번호 정책 검증 구현
- 에러 핸들링 (존재하지 않는 이메일, 업데이트 실패 등) 구현
- 로그인 페이지에 비밀번호 재설정 링크 추가
- 비밀번호 업데이트 성공 시 로그인 페이지로 리다이렉트 및 성공 메시지 표시
- Jest + React Testing Library 테스트 환경 활용
- 8개의 비밀번호 재설정 요청 테스트 케이스 작성 및 모두 통과
- 7개의 새 비밀번호 설정 테스트 케이스 작성 및 모두 통과
- 모든 코드 린트 오류 없음

### File List
#### 생성된 파일
- `app/auth/reset-password/page.tsx` - 비밀번호 재설정 요청 페이지
- `app/auth/update-password/page.tsx` - 새 비밀번호 설정 페이지
- `components/auth/password-reset-request-form.tsx` - 비밀번호 재설정 요청 폼 컴포넌트
- `components/auth/password-update-form.tsx` - 새 비밀번호 설정 폼 컴포넌트
- `__tests__/password-reset-request-form.test.tsx` - 비밀번호 재설정 요청 폼 테스트
- `__tests__/password-update-form.test.tsx` - 새 비밀번호 설정 폼 테스트

#### 수정된 파일
- `app/auth/signin/page.tsx` - 비밀번호 재설정 링크 추가 및 성공 메시지 표시

#### 테스트 커버리지
- 이메일 형식 유효성 검사
- 존재하지 않는 이메일 에러 처리
- 비밀번호 재설정 이메일 발송 성공/실패
- 비밀번호 정책 검증 (8자 이상, 특수문자 포함)
- 비밀번호 확인 일치 검증
- 비밀번호 업데이트 성공/실패 처리
- 로딩 상태 표시
- 성공 후 재시도 기능

## QA Results
*QA 에이전트가 검토 후 작성*
