# Story 4.2: 노트 내용 기반 자동 요약 생성

## Status
Ready for Review

## Story
**As a** 로그인한 사용자,
**I want** 노트 내용을 기반으로 AI가 자동으로 요약을 생성하도록,
**so that** 긴 노트의 핵심 내용을 빠르게 파악할 수 있다

## Acceptance Criteria
1. 노트 상세 페이지에서 "AI 요약 생성" 버튼이 표시된다
2. 버튼 클릭 시 Gemini API를 호출하여 요약을 생성한다
3. 생성된 요약이 3-6개의 핵심 포인트로 구성된다
4. 요약 생성 중 로딩 상태가 표시된다
5. 요약 생성 실패 시 사용자에게 적절한 에러 메시지가 표시된다
6. 요약 결과를 데이터베이스에 저장한다
7. 이미 요약이 있는 노트의 경우 기존 내용을 덮어쓸 수 있다
8. 요약 생성에 소요된 시간이 로그에 기록된다
9. 토큰 제한(8k)을 초과하는 노트는 자동으로 잘라서 처리한다

## Tasks / Subtasks
- [x] Task 1: 노트 상세 페이지에 AI 요약 UI 추가 (AC: 1, 4)
  - [x] 노트 상세 페이지 컴포넌트에 요약 섹션 추가
  - [x] "AI 요약 생성" 버튼 컴포넌트 구현
  - [x] 요약 결과 표시 영역 구현
  - [x] 로딩 상태 표시 컴포넌트 구현
  - [x] 요약 섹션 스타일링 및 반응형 디자인

- [x] Task 2: 요약 생성 Server Action 구현 (AC: 2, 5, 6, 7)
  - [x] `generateNoteSummary` Server Action 구현
  - [x] 노트 권한 검증 로직 추가
  - [x] 기존 요약 덮어쓰기 로직 구현
  - [x] 요약 결과를 summaries 테이블에 저장
  - [x] 에러 핸들링 및 사용자 친화적 메시지 구현

- [x] Task 3: 데이터베이스 스키마 및 쿼리 구현 (AC: 6, 7)
  - [x] summaries 테이블 스키마 확인/수정
  - [x] 요약 저장을 위한 Drizzle 쿼리 구현
  - [x] 기존 요약 조회 쿼리 구현
  - [x] 요약 업데이트 쿼리 구현
  - [x] 데이터베이스 마이그레이션 실행

- [x] Task 4: AI 요약 생성 로직 통합 (AC: 2, 3, 8, 9)
  - [x] 기존 `generateSummary` 함수와 Server Action 연동
  - [x] 토큰 제한 검증 및 자동 자르기 로직 적용
  - [x] 요약 품질 검증 로직 통합
  - [x] API 호출 최적화 및 에러 처리 강화
  - [x] 요약 생성 시간 측정 및 로깅

- [x] Task 5: 테스트 작성 (모든 AC)
  - [x] `__tests__/notes/note-summary.test.tsx` 생성
  - [x] `__tests__/actions/generate-note-summary.test.ts` 생성
  - [x] 요약 생성 UI 테스트 작성
  - [x] Server Action 테스트 작성
  - [x] 에러 케이스 테스트 작성
  - [x] 데이터베이스 연동 테스트 작성

## Dev Notes

### Previous Story Insights
[Source: Story 4.1 - Dev Agent Record]

**Key Learnings:**
- AI 기능은 `/lib/ai/` 디렉토리에 모듈화되어 구현
- `generateSummary` 함수가 이미 구현되어 있음
- 토큰 제한(8k) 및 에러 핸들링 로직 완성
- 개발 환경에서 graceful fallback 처리 구현
- API 호출 로깅 및 모니터링 시스템 구축

**Current AI Infrastructure:**
- `/lib/ai/summarize.ts`: 요약 생성 함수
- `/lib/ai/gemini-client.ts`: API 클라이언트 및 토큰 관리
- `/lib/ai/logger.ts`: 로깅 및 모니터링
- `/lib/ai/config.ts`: 설정 관리

### Data Models
[Source: architecture.md#2-데이터-모델]

**Existing Tables:**
- `notes`: id, user_id, title, content, created_at, updated_at
- `summaries`: note_id, model, content, created_at

**Updated Schema:**
```typescript
interface Note {
  id: string
  userId: string
  title: string
  content: string
  createdAt: Date
  updatedAt: Date
}

interface Summary {
  id: string
  noteId: string
  model: string
  content: string
  createdAt: Date
}
```

### Component Specifications
[Source: architecture.md#1-기술-스택]

**UI Components:**
- Location: `/components/notes/` 디렉토리
- Pattern: shadcn/ui + Tailwind CSS
- State Management: React hooks (useState, useEffect)
- Error Handling: 사용자 친화적 에러 메시지

**File Structure:**
```
/components/notes/
├── note-summary-section.tsx    # 요약 표시 섹션
└── generate-summary-button.tsx # 요약 생성 버튼
```

### Server Action Specifications
[Source: architecture.md#4-서버-액션]

**Server Action: `generateNoteSummary`**
- Location: `/lib/actions/notes.ts` (기존 파일 확장)
- Purpose: 노트 요약 생성 및 저장
- Input: noteId
- Output: success, summary, error
- Authentication: 사용자 인증 필수
- Authorization: 노트 소유자만 접근 가능

**Integration Points:**
- `generateSummary` 함수 호출 (Gemini API)
- `logSuccess`/`logError` 로깅 함수 사용
- Drizzle ORM으로 데이터베이스 저장
- `revalidatePath`로 캐시 무효화

### File Locations
[Source: architecture.md#1-기술-스택]

**New Files to Create:**
- `components/notes/note-summary-section.tsx` - 요약 표시 섹션
- `components/notes/generate-summary-button.tsx` - 요약 생성 버튼
- `__tests__/notes/note-summary.test.tsx` - 요약 UI 테스트
- `__tests__/actions/generate-note-summary.test.ts` - Server Action 테스트

**Files to Modify:**
- `app/notes/[id]/page.tsx` - 노트 상세 페이지에 요약 섹션 추가
- `lib/actions/notes.ts` - `generateNoteSummary` Server Action 추가

### Testing Requirements
[Source: architecture.md#1-기술-스택]

**Test Framework:** Jest + React Testing Library

**Test Strategy:**
- Unit Tests: 각 컴포넌트별 독립 테스트
- Integration Tests: Server Action과 데이터베이스 연동
- E2E Tests: 사용자 시나리오 테스트

**Test Coverage:**
1. 요약 생성 버튼 클릭 시나리오
2. 로딩 상태 표시 및 숨김
3. 요약 결과 표시 및 스타일링
4. 에러 상태 처리 및 메시지 표시
5. 기존 요약 덮어쓰기 기능
6. 권한 검증 (다른 사용자 노트 접근)
7. 토큰 제한 초과 노트 처리
8. 데이터베이스 저장 및 조회

**Mock Strategy:**
```typescript
// AI 함수 Mock
jest.mock('@/lib/ai', () => ({
  generateSummary: jest.fn()
}))

// 데이터베이스 Mock
jest.mock('@/lib/db', () => ({
  db: {
    select: jest.fn(),
    insert: jest.fn(),
    update: jest.fn()
  }
}))
```

### Technical Constraints
[Source: architecture.md#6-배포-운영]

**Performance Requirements:**
- 요약 생성 시간: 10초 이내
- 토큰 제한: 8k 토큰
- API 호출 최적화

**Security Requirements:**
- 사용자 인증 필수
- 노트 소유자 권한 검증
- 서버사이드에서만 AI API 호출

**User Experience:**
- 직관적인 UI/UX
- 명확한 로딩 상태 표시
- 에러 상황에서의 적절한 안내

## Testing

### Test Framework
Jest + React Testing Library

### Test Files
1. `__tests__/notes/note-summary.test.tsx` - 요약 UI 테스트
2. `__tests__/actions/generate-note-summary.test.ts` - Server Action 테스트

### Test Standards
- 각 컴포넌트별 단위 테스트 작성
- 사용자 상호작용 시나리오 테스트
- 에러 케이스 포함한 포괄적 테스트
- 데이터베이스 연동 테스트

### Testing Patterns
```typescript
// 컴포넌트 테스트 패턴
describe('NoteSummarySection', () => {
  it('should display existing summary when available', () => {
    // Given: 기존 요약이 있는 노트
    // When: 컴포넌트 렌더링
    // Then: 요약 내용이 표시됨
  })
})

// Server Action 테스트 패턴
describe('generateNoteSummary', () => {
  it('should generate and save summary successfully', async () => {
    // Given: 유효한 노트 ID
    // When: Server Action 호출
    // Then: 요약 생성 및 저장 성공
  })
})
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Story 4.2 초안 생성 | Scrum Master (Bob) |
| 2025-01-27 | 1.1 | Story 4.2 개발 완료 | Dev Agent (Claude Sonnet 4.5) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
1. **데이터베이스 마이그레이션 문제**
   - **문제**: `drizzle-kit push` 명령어 실행 시 TypeError 발생
   - **원인**: Drizzle Kit 버전 호환성 문제
   - **해결**: `drizzle-kit migrate` 명령어로 대체하여 성공적으로 마이그레이션 적용
   - **파일**: `drizzle/schema.ts`

2. **서버 컴포넌트에서 Server Action 호출 문제**
   - **문제**: 서버 컴포넌트에서 직접 Server Action 호출 시도
   - **원인**: Next.js App Router의 서버/클라이언트 컴포넌트 분리 원칙 위반
   - **해결**: 클라이언트 컴포넌트(`NoteDetailClient`)로 분리하여 해결
   - **파일**: `app/notes/[id]/page.tsx`, `app/notes/[id]/note-detail-client.tsx`

### Completion Notes List
1. **UI 컴포넌트 구현 완료**: 요약 표시 섹션, 로딩 상태 컴포넌트 구현
2. **데이터베이스 스키마 업데이트**: summaries 테이블 스키마 확인 및 마이그레이션 적용
3. **Server Action 구현**: `generateNoteSummary` 함수로 요약 생성 기능 구현
4. **에러 핸들링**: 요약 생성 실패 시 적절한 에러 메시지 표시
5. **테스트 작성**: 포괄적인 단위 테스트 및 통합 테스트 작성
6. **개발 환경 지원**: API 키 없을 때 graceful fallback 처리

### File List
**Created:**
- `components/notes/note-summary-section.tsx` - 요약 표시 섹션
- `app/notes/[id]/note-detail-client.tsx` - 노트 상세 페이지 클라이언트 컴포넌트
- `__tests__/actions/generate-note-summary.test.ts` - Server Action 테스트
- `__tests__/notes/note-summary.test.tsx` - UI 컴포넌트 테스트

**Modified:**
- `app/notes/[id]/page.tsx` - 서버 컴포넌트로 변경하고 클라이언트 컴포넌트 분리
- `lib/actions/notes.ts` - `generateNoteSummary` Server Action 추가, `getNoteById` 함수 업데이트

## QA Results
(To be filled by QA Agent)
